name: Deploy N8N Workflow Automation

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:
    inputs:
      port:
        description: 'Puerto para el contenedor (default: 8022)'
        required: false
        default: '8022'
      domain:
        description: 'Dominio personalizado (default: n8n.autosystemprojects.site)'
        required: false
        default: 'n8n.autosystemprojects.site'

permissions:
  contents: read
  packages: write

env:
  DEFAULT_PORT: 8022
  DEFAULT_DOMAIN: n8n.autosystemprojects.site

jobs:
  create-docker-image:
    runs-on: ubuntu-latest
    outputs:
      repo_name_lower: ${{ steps.repo_name_step.outputs.name }}
      github_actor_lower: ${{ steps.repo_name_step.outputs.actor_lower }}
      deployment_port: ${{ steps.config_step.outputs.port }}
      deployment_domain: ${{ steps.config_step.outputs.domain }}
      image_tag: ${{ steps.config_step.outputs.image_tag }}
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      # Configurar par√°metros de despliegue
      - name: Configurar par√°metros de despliegue
        id: config_step
        run: |
          # Usar inputs del workflow_dispatch o valores por defecto
          PORT="${{ github.event.inputs.port || env.DEFAULT_PORT }}"
          DOMAIN="${{ github.event.inputs.domain || env.DEFAULT_DOMAIN }}"
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          
          # Crear tag √∫nico basado en puerto y timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          IMAGE_TAG="n8n-port-${PORT}-${TIMESTAMP}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          echo "Deployment configuration:"
          echo "Port: $PORT"
          echo "Domain: $DOMAIN"
          echo "Image Tag: $IMAGE_TAG"

      # Convertir nombres a min√∫sculas
      - name: Set names to lowercase
        id: repo_name_step
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_LOWER=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')

          echo "name=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "actor_lower=$ACTOR_LOWER" >> $GITHUB_OUTPUT

          echo "Repository name: $REPO_LOWER"
          echo "GitHub actor: $ACTOR_LOWER"

      # Login a GitHub Container Registry
      - name: Login a GitHub Container Registry
        run: |
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          echo '${{ secrets.TOKEN_N8N }}' | docker login ghcr.io -u ${ACTOR_LOWER} --password-stdin

      # Construir y subir imagen Docker
      - name: Construir y subir imagen Docker de N8N
        run: |
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          REPO_LOWER=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_FULL_TAG="ghcr.io/${ACTOR_LOWER}/${REPO_LOWER}:${{ steps.config_step.outputs.image_tag }}"
          IMAGE_LATEST_TAG="ghcr.io/${ACTOR_LOWER}/${REPO_LOWER}:latest"
          
          echo "Building N8N image with tags:"
          echo "- Specific: $IMAGE_FULL_TAG"
          echo "- Latest: $IMAGE_LATEST_TAG"

          # Construir imagen con Node.js 22
          docker build . \
            --tag $IMAGE_FULL_TAG \
            --tag $IMAGE_LATEST_TAG \
            --build-arg NODE_VERSION=22 \
            --build-arg N8N_PORT=${{ steps.config_step.outputs.port }}

          # Subir ambas tags
          docker push $IMAGE_FULL_TAG
          docker push $IMAGE_LATEST_TAG

          echo "‚úÖ Im√°genes Docker subidas exitosamente"

  deploy:
    needs: create-docker-image
    runs-on: ubuntu-latest
    env:
      N8N_DOMAIN: "nochon_1.autosystemprojects.site"
      N8N_PORT: "8024"
      LETSENCRYPT_EMAIL: "admin_2@autosystemprojects.site"
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar par√°metros de despliegue
        id: deploy_config
        run: |
          PORT="${{ github.event.inputs.port || env.N8N_PORT }}"
          DOMAIN="${{ github.event.inputs.domain || env.N8N_DOMAIN }}"
          
          # Generar nombres √∫nicos para contenedor
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          CONTAINER_NAME="n8n_${PORT}_${TIMESTAMP}"
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "container_name=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Configuraci√≥n de despliegue:"
          echo "Puerto: $PORT"
          echo "Dominio: $DOMAIN"
          echo "Contenedor: $CONTAINER_NAME"

      - name: Convertir nombres a min√∫sculas
        id: repo_names
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_LOWER=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          
          echo "name=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "actor_lower=$ACTOR_LOWER" >> $GITHUB_OUTPUT

      - name: Extraer credenciales SSH
        id: ssh_credentials
        run: |
          AUTH_SERVER="${{ secrets.AUTH_SERVER }}"
          if [[ "$AUTH_SERVER" == *"@"* ]]; then
            USERNAME=$(echo "$AUTH_SERVER" | cut -d'@' -f1)
            HOST=$(echo "$AUTH_SERVER" | cut -d'@' -f2)
          else
            USERNAME="root"
            HOST="$AUTH_SERVER"
          fi
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "host=$HOST" >> $GITHUB_OUTPUT

      - name: Desplegar en servidor VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.ssh_credentials.outputs.host }}
          username: ${{ steps.ssh_credentials.outputs.username }}
          password: ${{ secrets.AUTH_PASS }}
          script: |
            set -e
            
            # Variables de configuraci√≥n
            PORT="${{ steps.deploy_config.outputs.port }}"
            DOMAIN="${{ steps.deploy_config.outputs.domain }}"
            CONTAINER_NAME="${{ steps.deploy_config.outputs.container_name }}"
            VOLUME_NAME="${{ steps.deploy_config.outputs.volume_name }}"
            ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
            REPO_LOWER=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
            IMAGE_URL="ghcr.io/${ACTOR_LOWER}/${REPO_LOWER}:latest"
            
            echo "üöÄ Iniciando despliegue de N8N..."
            echo "Puerto: $PORT"
            echo "Dominio: $DOMAIN"
            echo "Contenedor: $CONTAINER_NAME"
            echo "Imagen: $IMAGE_URL"
            
            # Crear directorio del proyecto si no existe
            PROJECT_DIR="/opt/n8n"
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR
            
            # Copiar archivos necesarios del repositorio
            echo "üìÅ Copiando archivos de configuraci√≥n..."
            
            # Crear estructura de directorios
            mkdir -p scripts nginx templates
            
            # Copiar script de configuraci√≥n desde el repositorio
            curl -H "Authorization: token ${{ secrets.TOKEN_N8N }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o scripts/setup-nginx.sh \
                 "https://api.github.com/repos/${{ github.repository }}/contents/scripts/setup-nginx.sh?ref=${{ github.sha }}"
            
            # Copiar plantillas de configuraci√≥n desde el repositorio
            curl -H "Authorization: token ${{ secrets.TOKEN_N8N }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o templates/n8n.conf.tpl \
                 "https://api.github.com/repos/${{ github.repository }}/contents/nginx/n8n.conf.tpl?ref=${{ github.sha }}"
            
            curl -H "Authorization: token ${{ secrets.TOKEN_N8N }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o templates/n8n-temp.conf.tpl \
                 "https://api.github.com/repos/${{ github.repository }}/contents/nginx/n8n-temp.conf.tpl?ref=${{ github.sha }}"
            
            # Configurar Nginx y SSL usando el script original
            echo "üîß Configurando Nginx y SSL para $DOMAIN..."
            export DOMAIN="$DOMAIN"
            export PORT="$PORT"
            export EMAIL="${{ env.LETSENCRYPT_EMAIL }}"
            chmod +x scripts/setup-nginx.sh
            ./scripts/setup-nginx.sh
            
            # Limpiar configuraciones antiguas de Nginx para evitar conflictos
            echo "üßπ Limpiando configuraciones antiguas de Nginx..."
            sudo rm -f /etc/nginx/sites-available/n8n
            sudo rm -f /etc/nginx/sites-enabled/n8n
            echo "‚úÖ Configuraciones antiguas eliminadas."
            
            # Login en GitHub Container Registry
            ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
            echo '${{ secrets.TOKEN_N8N }}' | docker login ghcr.io -u ${ACTOR_LOWER} --password-stdin
            
            # Pull de la nueva imagen
            docker pull $IMAGE_URL
            
            # Detener y eliminar contenedores n8n antiguos para este puerto
            OLD_CONTAINERS=$(docker ps -a -q --filter "name=n8n_${PORT}")
            if [ ! -z "$OLD_CONTAINERS" ]; then
              echo "üõë Deteniendo y eliminando contenedores antiguos en el puerto $PORT..."
              docker stop $OLD_CONTAINERS || true
              docker rm $OLD_CONTAINERS || true
              echo "‚úÖ Contenedores antiguos eliminados."
            fi
            
            # Ejecutar nuevo contenedor
            echo "üöÄ Iniciando nuevo contenedor N8N...."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p $PORT:$PORT \
              -e N8N_BASIC_AUTH_ACTIVE=true \
              -e N8N_BASIC_AUTH_USER=${{ secrets.N8N_BASIC_AUTH_USER || 'admin' }} \
              -e N8N_BASIC_AUTH_PASSWORD=${{ secrets.N8N_BASIC_AUTH_PASSWORD || 'adminjonnyca237' }} \
              -e WEBHOOK_URL=https://$DOMAIN/ \
              -e N8N_EDITOR_BASE_URL=https://$DOMAIN/ \
              -e VUE_APP_URL_BASE_API=https://$DOMAIN/ \
              -e N8N_HOST=$DOMAIN \
              -e N8N_TRUST_PROXY=true \
              -e N8N_PROTOCOL=https \
              -e N8N_PORT=$PORT \
              -e GENERIC_TIMEZONE=America/Bogota \
              -e DB_TYPE=sqlite \
              -e N8N_USER_FOLDER=/home/n8n/.n8n \
              -e DB_SQLITE_POOL_SIZE=10 \
              -e N8N_SECURE_COOKIE=true \
              -e N8N_ENCRYPTION_KEY=n8n-default-key-change-me \
              -e N8N_LOG_LEVEL=info \
              -e N8N_LOG_OUTPUT=file \
              -e N8N_LOG_FILE_LOCATION=/app/logs/ \
              -e N8N_RUNNERS_ENABLED=true \
              --health-cmd="curl -f http://localhost:$PORT/healthz || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              $IMAGE_URL
            
            # Verificar que el contenedor est√© corriendo
            sleep 10
            if docker ps | grep -q $CONTAINER_NAME; then
              echo "‚úÖ Contenedor $CONTAINER_NAME iniciado exitosamente"
              echo "üåê N8N disponible en: https://$DOMAIN"
              echo "üìä Puerto interno: $PORT"
              echo "üíæ Volumen de datos: $VOLUME_NAME"
              
              # Mostrar logs iniciales
              echo "üìã Logs iniciales del contenedor:"
              docker logs --tail 20 $CONTAINER_NAME
            else
              echo "‚ùå Error: El contenedor no pudo iniciarse"
              docker logs $CONTAINER_NAME
              exit 1
            fi
            
            # Limpiar im√°genes de Docker no utilizadas
            echo "üßπ Limpiando im√°genes de Docker no utilizadas..."
            docker image prune -a -f
            
            echo "üéâ Despliegue de N8N completado exitosamente!"

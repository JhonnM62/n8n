name: Deploy N8N Workflow Automation

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:
    inputs:
      port:
        description: 'Puerto para el contenedor (default: 8022)'
        required: false
        default: '8022'
      domain:
        description: 'Dominio personalizado (default: n8n.autosystemprojects.site)'
        required: false
        default: 'n8n.autosystemprojects.site'

env:
  DEFAULT_PORT: 8022
  DEFAULT_DOMAIN: n8n.autosystemprojects.site

jobs:
  create-docker-image:
    runs-on: ubuntu-latest
    outputs:
      repo_name_lower: ${{ steps.repo_name_step.outputs.name }}
      github_actor_lower: ${{ steps.repo_name_step.outputs.actor_lower }}
      deployment_port: ${{ steps.config_step.outputs.port }}
      deployment_domain: ${{ steps.config_step.outputs.domain }}
      image_tag: ${{ steps.config_step.outputs.image_tag }}
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      # Configurar par√°metros de despliegue
      - name: Configurar par√°metros de despliegue
        id: config_step
        run: |
          # Usar inputs del workflow_dispatch o valores por defecto
          PORT="${{ github.event.inputs.port || env.DEFAULT_PORT }}"
          DOMAIN="${{ github.event.inputs.domain || env.DEFAULT_DOMAIN }}"
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          
          # Crear tag √∫nico basado en puerto y timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          IMAGE_TAG="n8n-port-${PORT}-${TIMESTAMP}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          echo "Deployment configuration:"
          echo "Port: $PORT"
          echo "Domain: $DOMAIN"
          echo "Image Tag: $IMAGE_TAG"

      # Convertir nombres a min√∫sculas
      - name: Set names to lowercase
        id: repo_name_step
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_LOWER=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')

          echo "name=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "actor_lower=$ACTOR_LOWER" >> $GITHUB_OUTPUT

          echo "Repository name: $REPO_LOWER"
          echo "GitHub actor: $ACTOR_LOWER"

      - name: Login en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ steps.repo_name_step.outputs.actor_lower }}
          password: ${{ secrets.AUTH_PASS }}

      # Generar archivo .env desde secrets
      - name: Generar archivo .env para N8N
        run: |
          echo '${{ secrets.ENV_FILE_CONTENT }}' > .env
          
          # Agregar configuraciones espec√≠ficas del despliegue
          echo "" >> .env
          echo "# Configuraci√≥n de despliegue autom√°tico" >> .env
          echo "N8N_PORT=${{ steps.config_step.outputs.port }}" >> .env
          echo "WEBHOOK_URL=https://${{ steps.config_step.outputs.domain }}/" >> .env
          echo "N8N_EDITOR_BASE_URL=https://${{ steps.config_step.outputs.domain }}/" >> .env
          
          echo "‚úÖ Archivo .env generado con configuraci√≥n de despliegue"

      # Construir y subir imagen Docker
      - name: Construir y subir imagen Docker de N8N
        run: |
          IMAGE_FULL_TAG="ghcr.io/${{ steps.repo_name_step.outputs.actor_lower }}/${{ steps.repo_name_step.outputs.name }}:${{ steps.config_step.outputs.image_tag }}"
          IMAGE_LATEST_TAG="ghcr.io/${{ steps.repo_name_step.outputs.actor_lower }}/${{ steps.repo_name_step.outputs.name }}:latest"
          
          echo "Building N8N image with tags:"
          echo "- Specific: $IMAGE_FULL_TAG"
          echo "- Latest: $IMAGE_LATEST_TAG"

          # Construir imagen con Node.js 22
          docker build . \
            --tag $IMAGE_FULL_TAG \
            --tag $IMAGE_LATEST_TAG \
            --build-arg NODE_VERSION=22

          # Subir ambas tags
          docker push $IMAGE_FULL_TAG
          docker push $IMAGE_LATEST_TAG

          echo "‚úÖ Im√°genes Docker subidas exitosamente"

          echo "‚úÖ Im√°genes Docker subidas exitosamente"

  deploy:
    needs: create-docker-image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar par√°metros de despliegue
        id: deploy_config
        run: |
          PORT="${{ github.event.inputs.port || '8022' }}"
          DOMAIN="${{ github.event.inputs.domain || 'n8n.autosystemprojects.site' }}"
          
          # Generar nombres √∫nicos para contenedor y volumen
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          CONTAINER_NAME="n8n_${PORT}_${TIMESTAMP}"
          VOLUME_NAME="n8n_data_${PORT}"
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "container_name=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          echo "volume_name=$VOLUME_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Configuraci√≥n de despliegue:"
          echo "Puerto: $PORT"
          echo "Dominio: $DOMAIN"
          echo "Contenedor: $CONTAINER_NAME"
          echo "Volumen: $VOLUME_NAME"

      - name: Convertir nombres a min√∫sculas
        id: repo_names
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_LOWER=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          
          echo "name=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "actor_lower=$ACTOR_LOWER" >> $GITHUB_OUTPUT

      - name: Desplegar en servidor VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AUTH_SERVER }}
          username: root
          password: ${{ secrets.AUTH_PASS }}
          script: |
            set -e
            
            # Variables de configuraci√≥n
            PORT="${{ steps.deploy_config.outputs.port }}"
            DOMAIN="${{ steps.deploy_config.outputs.domain }}"
            CONTAINER_NAME="${{ steps.deploy_config.outputs.container_name }}"
            VOLUME_NAME="${{ steps.deploy_config.outputs.volume_name }}"
            IMAGE_URL="ghcr.io/${{ steps.repo_names.outputs.actor_lower }}/${{ steps.repo_names.outputs.name }}:latest"
            
            echo "üöÄ Iniciando despliegue de N8N..."
            echo "Puerto: $PORT"
            echo "Dominio: $DOMAIN"
            echo "Contenedor: $CONTAINER_NAME"
            echo "Imagen: $IMAGE_URL"
            
            # Crear directorio del proyecto si no existe
            PROJECT_DIR="/opt/n8n"
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR
            
            # Configurar Nginx si no existe la configuraci√≥n para este dominio
            NGINX_CONFIG="/etc/nginx/sites-available/$DOMAIN"
            if [ ! -f "$NGINX_CONFIG" ]; then
              echo "üìù Configurando Nginx para $DOMAIN..."
              
              # Crear configuraci√≥n de Nginx
              cat > $NGINX_CONFIG << 'EOF'
            server {
                listen 80;
                server_name $DOMAIN www.$DOMAIN;
                
                # Redirecci√≥n HTTP a HTTPS
                return 301 https://$server_name$request_uri;
            }
            
            server {
                listen 443 ssl http2;
                server_name $DOMAIN www.$DOMAIN;
                
                # Configuraci√≥n SSL (se configurar√° con Certbot)
                ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
                
                # Headers de seguridad
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-XSS-Protection "1; mode=block" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header Referrer-Policy "no-referrer-when-downgrade" always;
                add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
                
                # Logs
                access_log /var/log/nginx/$DOMAIN.access.log;
                error_log /var/log/nginx/$DOMAIN.error.log;
                
                # Configuraci√≥n principal para N8N
                location / {
                    proxy_pass http://localhost:$PORT;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    
                    # Timeouts
                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                }
                
                # WebSocket support para N8N
                location /socket.io/ {
                    proxy_pass http://localhost:$PORT;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
                
                # Webhooks de N8N
                location /webhook/ {
                    proxy_pass http://localhost:$PORT;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    
                    # Permitir cuerpos de request m√°s grandes para webhooks
                    client_max_body_size 50M;
                }
                
                # Health check
                location /health {
                    proxy_pass http://localhost:$PORT/healthz;
                    proxy_set_header Host $host;
                }
                
                # L√≠mites
                client_max_body_size 100M;
            }
            EOF
              
              # Reemplazar variable en el archivo
              sed -i "s/\$DOMAIN/$DOMAIN/g" $NGINX_CONFIG
              sed -i "s/\$PORT/$PORT/g" $NGINX_CONFIG
              
              # Habilitar sitio
              ln -sf $NGINX_CONFIG /etc/nginx/sites-enabled/
              
              # Verificar configuraci√≥n de Nginx
              nginx -t
              
              # Recargar Nginx
              systemctl reload nginx
              
              echo "‚úÖ Nginx configurado para $DOMAIN"
            else
              echo "‚ÑπÔ∏è Configuraci√≥n de Nginx ya existe para $DOMAIN"
            fi
            
            # Configurar SSL con Certbot si no existe
            if [ ! -d "/etc/letsencrypt/live/$DOMAIN" ]; then
              echo "üîí Configurando SSL con Certbot para $DOMAIN..."
              
              # Obtener certificado SSL
              certbot --nginx -d $DOMAIN -d www.$DOMAIN --non-interactive --agree-tos --email admin@autosystemprojects.site
              
              # Configurar renovaci√≥n autom√°tica si no existe
              if ! crontab -l | grep -q "certbot renew"; then
                (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -
                echo "‚úÖ Renovaci√≥n autom√°tica de SSL configurada"
              fi
              
              echo "‚úÖ SSL configurado para $DOMAIN"
            else
              echo "‚ÑπÔ∏è Certificado SSL ya existe para $DOMAIN"
            fi
            
            # Crear archivo .env
            echo '${{ secrets.ENV_FILE_CONTENT }}' > .env
            
            # Agregar configuraciones espec√≠ficas del despliegue
            echo "" >> .env
            echo "# Configuraci√≥n de despliegue autom√°tico" >> .env
            echo "N8N_PORT=$PORT" >> .env
            echo "WEBHOOK_URL=https://$DOMAIN/" >> .env
            echo "N8N_EDITOR_BASE_URL=https://$DOMAIN/" >> .env
            echo "N8N_HOST=0.0.0.0" >> .env
            echo "N8N_PROTOCOL=https" >> .env
            echo "N8N_SECURE_COOKIE=true" >> .env
            
            echo "‚úÖ Archivo .env configurado"
            
            # Login en GitHub Container Registry
            echo '${{ secrets.AUTH_PASS }}' | docker login ghcr.io -u ${{ steps.repo_names.outputs.actor_lower }} --password-stdin
            
            # Pull de la nueva imagen
            docker pull $IMAGE_URL
            
            # Crear volumen Docker si no existe
            if ! docker volume ls | grep -q "$VOLUME_NAME"; then
              docker volume create $VOLUME_NAME
              echo "‚úÖ Volumen Docker creado: $VOLUME_NAME"
            else
              echo "‚ÑπÔ∏è Volumen Docker ya existe: $VOLUME_NAME"
            fi
            
            # Detener contenedores anteriores en el mismo puerto (si existen)
            EXISTING_CONTAINERS=$(docker ps -q --filter "publish=$PORT")
            if [ ! -z "$EXISTING_CONTAINERS" ]; then
              echo "üõë Deteniendo contenedores existentes en puerto $PORT..."
              docker stop $EXISTING_CONTAINERS
              docker rm $EXISTING_CONTAINERS
              echo "‚úÖ Contenedores anteriores removidos"
            fi
            
            # Ejecutar nuevo contenedor
            echo "üöÄ Iniciando nuevo contenedor N8N..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p $PORT:8001 \
              --env-file .env \
              -v $VOLUME_NAME:/home/node/.n8n \
              -v $PROJECT_DIR/.env:/app/.env:ro \
              --health-cmd="curl -f http://localhost:8001/healthz || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              $IMAGE_URL
            
            # Verificar que el contenedor est√© corriendo
            sleep 10
            if docker ps | grep -q $CONTAINER_NAME; then
              echo "‚úÖ Contenedor $CONTAINER_NAME iniciado exitosamente"
              echo "üåê N8N disponible en: https://$DOMAIN"
              echo "üìä Puerto interno: $PORT"
              echo "üíæ Volumen de datos: $VOLUME_NAME"
              
              # Mostrar logs iniciales
              echo "üìã Logs iniciales del contenedor:"
              docker logs --tail 20 $CONTAINER_NAME
            else
              echo "‚ùå Error: El contenedor no pudo iniciarse"
              docker logs $CONTAINER_NAME
              exit 1
            fi
            
            echo "üéâ Despliegue de N8N completado exitosamente!"
